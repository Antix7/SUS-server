<!DOCTYPE html>
<html lang="pl-PL">
<head>
    <meta charset="UTF-8">
    <title>Wyświetlanie sprzętu</title>

    <style>
        #outer > * {
            display: inline-block;
            border-right-style: solid;
        }
        th, td {
            border: 1px solid black;
            padding: 3px;
        }
        #delete {
            position: fixed;
            right: 0;
            top:0;
        }
    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <script>
        $(document).ready(function(){

            $.get(
                "/sprzet_panel/wyswietl/filters",
                function(data, status) {
                    $("#kategoria").html(data.kategoria);
                    $("#stan").html(data.stan);
                    $("#lokalizacja").html(data.lokalizacja);
                    $("#status").html(data.status);
                    $("#wlasciciel").html(data.wlasciciel);
                    $("#uzytkownik").html(data.uzytkownik);

                    // this has to be executed after the get request is completed,
                    // otherwise #kategoria_form does not exist yet
                    $("#kategoria_form").change(function() { // async?
                        $.post(
                            "/sprzet_panel/wyswietl/filters/stany",
                            {kategoria: $("#kategoria_form").serializeArray()},
                            function (data) {
                                $("#stan").html(data);
                            }
                        );
                    });
                });




            $("#submit_btn").click(function() {
                let form_data = {
                    kategoria: $("#kategoria_form").serializeArray(),
                    stan: $("#stan_form").serializeArray(),
                    lokalizacja: $("#lokalizacja_form").serializeArray(),
                    status: $("#status_form").serializeArray(),
                    nazwa: $("#nazwa_form").serializeArray(),
                    wlasciciel: $("#wlasciciel_form").serializeArray(),
                    uzytkownik: $("#uzytkownik_form").serializeArray()
                };
                $.post(
                    "/sprzet_panel/wyswietl/auth",
                    form_data,
                    function (data, status) {
                        $("#sprzet_div").html(data);

                        $('.edytuj').submit(function(e) {
                            e.preventDefault();
                            let myID = $(this).parent().parent().attr("data-row-id");
                            location.href = `/sprzet_panel/edytuj?id=${myID}`;
                        });

                        $('.zabierz').each(function() {
                            let ogid = $(this).parent().parent().attr("data-row-ogid");
                            if(ogid === "null")
                                return;
                            $(this).prop('disabled', true);
                        });

                        $('.odloz').each(function() {
                            let ogid = $(this).parent().parent().attr("data-row-ogid");
                            if(ogid !== "null")
                                return;
                            $(this).prop('disabled', true);
                        });

                        $('.forger').each(function() {
                            let ogid = $(this).parent().parent().attr("data-row-ogid");
                            if(ogid !== "null")
                                return;
                            $(this).prop('disabled', true);
                        });

                        $('.zabierz').click(function(e) {
                            let ogid = $(this).parent().parent().attr("data-row-ogid");
                            if(ogid !== "null") {
                                $(this).prop('disabled', true);
                                return;
                            }
                            e.preventDefault();
                            let num = prompt("ile chcesz zabrać?");
                            let myID = $(this).parent().parent().attr("data-row-id");
                            let ilosc = $(this).parent().parent().find('.ilosc');
                            let form_data = {
                                id: myID,
                                amount: num
                            };
                            $.post(
                                "/sprzet_panel/zabierz",
                                form_data,
                                function(data) {
                                    $("#sprzet_div tbody").append(data['newRow']);
                                    ilosc.text(ilosc.text() - num);
                                }
                            )
                        });

                        $('.odloz').click(function() {
                            let ogid = $(this).parent().parent().attr("data-row-ogid");
                            if(ogid === "null") {
                                $(this).prop('disabled', true);
                                return;
                            }
                            let myRow = $(this).parent().parent();
                            let myID = myRow.attr("data-row-id");
                            let ogID = myRow.attr("data-row-ogid");
                            let ilosc = myRow.find('.ilosc');
                            let ogRow = $(`tr[data-row-id=${ogID}]`);
                            let ogRow_ilosc = ogRow.find('.ilosc')
                            let form_data = {
                                id: myID,
                                amount: ilosc.text(),
                                ogid: ogID
                            };
                            $.post(
                                "/sprzet_panel/odloz",
                                form_data,
                                function(data) {
                                    myRow.remove();
                                    ogRow_ilosc.text(parseInt(ogRow_ilosc.text()) + parseInt(ilosc.text()));
                                }
                            )
                        });

                        $('.forger').click(function() {
                            let ogid = $(this).parent().parent().attr("data-row-ogid");
                            if(ogid === "null") {
                                $(this).prop('disabled', true);
                                return;
                            }
                            let myRow = $(this).parent().parent();
                            let myID = myRow.attr("data-row-id");
                            let form_data = {
                                id: myID
                            };
                            $.post(
                                "/sprzet_panel/zapomnij",
                                form_data,
                                function(data) {
                                    myRow.attr("data-row-ogid", "null");
                                    myRow.find('.zabierz').prop('disabled', false);
                                    myRow.find('.odloz').prop('disabled', true);
                                    myRow.find('.forger').prop('disabled', true);
                                }
                            )
                        });
                    }
                );
            });

            $('#delete').submit(function(e) {
                e.preventDefault();
                let toDelete = [];
                $('.selectRow').each(function() {
                    if(this.checked) {
                        let myID = $(this).parent().parent().attr("data-row-id");
                        toDelete.push(myID);
                    }
                });
                if(toDelete.length === 0)
                    return 0;
                $.post(
                    "/sprzet_panel/wyswietl/usun",
                    {'toDelete': toDelete},
                    function(data, status) {
                        $('.selectRow').each(function() {
                            if(this.checked) {
                                $(this).parent().parent().remove();
                            }
                        });
                    }
                )
            });
        });


    </script>

</head>
<body>

<form id="delete">
    <input type="submit" value="usuń">
</form>

<!--<form action="/sprzet_panel" method="get">
    <input type="submit" value="Wróć">
</form>-->
<button onclick="history.back()">Wróć</button>



<div id="outer">

    <div id="kategoria"></div>
    <div id="stan">Wybierz kategorię</div>
    <div id="lokalizacja"></div>
    <div id="status"></div>
    <div id="nazwa">
        <form id="nazwa_form">
            <input type="text" name="nazwa" placeholder="Nazwa">
        </form>
    </div>
    <div id="wlasciciel"></div>
    <div id="uzytkownik"></div>

</div>

<button id="submit_btn">Wyświetl sprzęt</button>

<div id="sprzet_div"></div>

</body>
</html>