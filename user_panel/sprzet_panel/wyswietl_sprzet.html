<!DOCTYPE html>
<html lang="pl-PL">
<head>
    <meta charset="UTF-8">
    <title>Wyświetlanie sprzętu</title>

    <style>
        #outer > * {
            display: inline-block;
            border-right-style: solid;
        }
        th, td {
            border: 1px solid black;
            padding: 3px;
        }
        #delete {
            position: fixed;
            right: 0;
            top:0;
        }
    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <script>

        function zabierz_function(my_this) {
            console.log(my_this);
            let ogid = $(my_this).parent().parent().attr("data-row-ogid");
            if(ogid !== "null") {
                $(my_this).prop('disabled', true);
                return;
            }
            let num = prompt("ile chcesz zabrać?");
            let myID = $(my_this).parent().parent().attr("data-row-id");
            let ilosc = $(my_this).parent().parent().find('.ilosc');
            let form_data = {
                id: myID,
                amount: num
            };
            $.post(
                "/sprzet_panel/zabierz",
                form_data,
                function(data) {
                    $("#sprzet_div tbody").append(data['newRow']);
                    ilosc.text(ilosc.text() - num);
                    let added = $("#sprzet_div tr").last();

                    added.find('.edytuj', function() {
                        e.preventDefault();
                        let myID = $(this).parent().parent().attr("data-row-id");
                        location.href = `/sprzet_panel/edytuj?id=${myID}`;
                    });

                    let ogid = added.attr("data-row-ogid");
                    if(ogid === "null") {
                        added.find('.forger').prop('disabled', true);
                        added.find('.odloz').prop('disabled', true);
                    }
                    else
                        added.find('.zabierz').prop('disabled', true);

                    added.find('.forger').click(function() {
                        forger_function($(this));
                    });
                    added.find('.odloz').click(function() {
                        odloz_function($(this));
                    });
                    added.find('.zabierz').click(function() {
                        zabierz_function($(this));
                    });
                }
            )
        }

        function odloz_function(my_this)  {
            let ogid = $(my_this).parent().parent().attr("data-row-ogid");
            if(ogid === "null") {
                $(my_this).prop('disabled', true);
                return;
            }
            let myRow = $(my_this).parent().parent();
            let myID = myRow.attr("data-row-id");
            let ogID = myRow.attr("data-row-ogid");
            let ilosc = myRow.find('.ilosc');
            let ogRow = $(`tr[data-row-id=${ogID}]`);
            let ogRow_ilosc = ogRow.find('.ilosc')
            let form_data = {
                id: myID,
                amount: ilosc.text(),
                ogid: ogID
            };
            $.post(
                "/sprzet_panel/odloz",
                form_data,
                function(data) {
                    myRow.remove();
                    ogRow_ilosc.text(parseInt(ogRow_ilosc.text()) + parseInt(ilosc.text()));
                }
            )
        }

        function forger_function(my_this) {
            let ogid = $(my_this).parent().parent().attr("data-row-ogid");
            if(ogid === "null") {
                $(my_this).prop('disabled', true);
                return;
            }
            let myRow = $(my_this).parent().parent();
            let myID = myRow.attr("data-row-id");
            let form_data = {
                id: myID
            };
            $.post(
                "/sprzet_panel/zapomnij",
                form_data,
                function(data) {
                    myRow.attr("data-row-ogid", "null");
                    myRow.find('.zabierz').prop('disabled', false);
                    myRow.find('.odloz').prop('disabled', true);
                    myRow.find('.forger').prop('disabled', true);
                }
            )
        }

        $(document).ready(function(){

            $.get(
                "/sprzet_panel/wyswietl/filters",
                function(data, status) {
                    $("#kategoria").html(data.kategoria);
                    $("#stan").html(data.stan);
                    $("#lokalizacja").html(data.lokalizacja);
                    $("#status").html(data.status);
                    $("#wlasciciel").html(data.wlasciciel);
                    $("#uzytkownik").html(data.uzytkownik);

                    // this has to be executed after the get request is completed,
                    // otherwise #kategoria_form does not exist yet
                    $("#kategoria_form").change(function() { // async?
                        $.post(
                            "/sprzet_panel/wyswietl/filters/stany",
                            {kategoria: $("#kategoria_form").serializeArray()},
                            function (data) {
                                $("#stan").html(data);
                            }
                        );
                    });
                });




            $("#submit_btn").click(function() {
                let sortowanie = [];
                $("#sort-form div").each(function() {
                    if($('[type="number"]', this).val() == '0')
                        return;
                    sortowanie.push([$('input[type="number"]', this).attr("name"), $('[type="number"]', this).val(), $('[type="checkbox"]', this).prop('checked')]);
                });
                sortowanie.sort(([n1, v1, w1], [n2, v2, w2]) => {
                    if(v1 === v2)
                        return 0;
                    return parseInt(v1) >= parseInt(v2) ? 1 : -1;
                });
                // if(sortowanie)
                //     console.log(sortowanie);
                let form_data = {
                    kategoria: $("#kategoria_form").serializeArray(),
                    stan: $("#stan_form").serializeArray(),
                    lokalizacja: $("#lokalizacja_form").serializeArray(),
                    status: $("#status_form").serializeArray(),
                    nazwa: $("#nazwa_form").serializeArray(),
                    wlasciciel: $("#wlasciciel_form").serializeArray(),
                    uzytkownik: $("#uzytkownik_form").serializeArray()
                };
                if(sortowanie.length !== 0)
                    form_data['sortData'] = sortowanie;
                $.post(
                    "/sprzet_panel/wyswietl/auth",
                    form_data,
                    function (data, status) {
                        $("#sprzet_div").html(data);

                        $('.edytuj').submit(function(e) {
                            e.preventDefault();
                            let myID = $(this).parent().parent().attr("data-row-id");
                            location.href = `/sprzet_panel/edytuj?id=${myID}`;
                        });

                        $('.zabierz').each(function() {
                            let ogid = $(this).parent().parent().attr("data-row-ogid");
                            if(ogid === "null")
                                return;
                            $(this).prop('disabled', true);
                        });

                        $('.odloz').each(function() {
                            let ogid = $(this).parent().parent().attr("data-row-ogid");
                            if(ogid !== "null")
                                return;
                            $(this).prop('disabled', true);
                        });

                        $('.forger').each(function() {
                            let ogid = $(this).parent().parent().attr("data-row-ogid");
                            if(ogid !== "null")
                                return;
                            $(this).prop('disabled', true);
                        });

                        $('.zabierz').click(function() {
                            zabierz_function($(this))
                        });

                        $('.odloz').click(function() {
                            odloz_function($(this))
                        });

                        $('.forger').click(function() {
                            forger_function($(this))
                        });
                    }
                );
            });

            $('#delete').submit(function(e) {
                e.preventDefault();
                let toDelete = [];
                $('.selectRow').each(function() {
                    if(this.checked) {
                        let myID = $(this).parent().parent().attr("data-row-id");
                        toDelete.push(myID);
                    }
                });
                if(toDelete.length === 0)
                    return 0;
                $.post(
                    "/sprzet_panel/wyswietl/usun",
                    {'toDelete': toDelete},
                    function(data, status) {
                        $('.selectRow').each(function() {
                            if(this.checked) {
                                $(this).parent().parent().remove();
                            }
                        });
                    }
                )
            });
        });


    </script>

</head>
<body>

<form id="delete">
    <input type="submit" value="usuń">
</form>

<!--<form action="/sprzet_panel" method="get">
    <input type="submit" value="Wróć">
</form>-->
<button onclick="history.back()">Wróć</button>



<div id="outer">

    <div id="kategoria"></div>
    <div id="stan">Wybierz kategorię</div>
    <div id="lokalizacja"></div>
    <div id="status"></div>
    <div id="nazwa">
        <form id="nazwa_form">
            <input type="text" name="nazwa" placeholder="Nazwa">
        </form>
    </div>
    <div id="wlasciciel"></div>
    <div id="uzytkownik"></div>

    <form id="sort-form">
        <b>SORTOWANIE</b>
        (0 to nie sortuj, im mniejszy numer tym ważniejsze, checkbox jeśli malejąco)
        <div>nazwa<input type="number" name="nazwa" value="0"> <input type="checkbox" name="nazwa-desc"></div>
        <div>kategoria<input type="number" name="kategoria" value="0"> <input type="checkbox" name="kategoria-desc"></div>
        <div>ilosc<input type="number" name="ilosc" value="0"> <input type="checkbox" name="ilosc-desc"></div>
        <div>lokalizacja<input type="number" name="lokalizacja" value="0"> <input type="checkbox" name="lokalizacja-desc"></div>
        <div>wlasciciel<input type="number" name="wlasciciel" value="0"> <input type="checkbox" name="wlasciciel-desc"></div>
        <div>uzytkownik<input type="number" name="uzytkownik" value="0"> <input type="checkbox" name="uzytkownik-desc"></div>
        <div>status<input type="number" name="status_id" value="0"> <input type="checkbox" name="status-desc"></div>
        <div>stan<input type="number" name="stan_id" value="0"> <input type="checkbox" name="stan-desc"></div>
    </form>

</div>

<button id="submit_btn">Wyświetl sprzęt</button>

<div id="sprzet_div"></div>

</body>
</html>