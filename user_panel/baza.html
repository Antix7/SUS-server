<!DOCTYPE html>
<html lang="pl-PL">
<head>
    <meta charset="UTF-8">
    <title>Sprzęt szczepu</title>
    <style>
        th, td {
            border: 1px solid black;
            padding: 3px;
        }
    </style>
</head>
<body>
<form id="addRow">
    <input type = "submit" value = "Dodaj wiersz">
</form>
<form id = "addInfo" style="display: none">
    <label for="nazwa">Nazwa</label><input type="text" id="nazwa"><br>
    <label for="ilosc">Ilość</label><input type="number" id="ilosc"><br>
    <label for="zdjecie">Zdjęcie</label><input type="file" id="zdjecie"><br>
    <label for="kategoria">Kategoria</label><select name="kategoria" id="kategoria">
        <option value="" disabled selected>===</option>
    </select><br>
    <label for="lokalizacja">Lokalizacja</label><select name="lokalizacja" id="lokalizacja">
        <option value="" disabled selected>===</option>
    </select><br>
    <label for="wlasciciel">Właściciel</label><select name="wlasciciel" id="wlasciciel">
        <option value="" disabled selected>===</option>
    </select><br>
    <label for="uzytkownik">Użytkownik</label><select name="uzytkownik" id="uzytkownik">
        <option value="" disabled selected>===</option>
    </select><br>
    <label for="status">Status</label><select name="status" id="status">
        <option value="" disabled selected>===</option>
    </select><br>
    <label for="stan">Stan</label><select name="stan" id="stan" disabled>
        <option value="" id="stan_primary" disabled selected>Najpierw wybierz kategorię</option>
    </select><br>
    <label for="opis">Dodatkowy opis</label><input type="text" id="opis"><br>
    <input type = "submit" value="Wyślij"><br>
</form>
<table id = "tabelka">
    {{tablebody}}
</table>
<form id="myForm">
    <input type="hidden" id="start" name="start" value="51">
    <input type = "submit" value = "Załaduj dalej"></input>
</form>
<br>
<div id = "error"></div>
<br>
<form action = "/panel" method = "get">
    <input type = "submit" value = "Wróć"><br>
</form>

<script>
    const form1 = document.getElementById("myForm");
    const tabelka = document.getElementById("tabelka");
    const errorDiv = document.getElementById("error");

    form1.addEventListener("submit", (e) => {
        console.log("lool");
        e.preventDefault();

        const formData = new FormData(form1);
        for (let key of formData.keys()) {
            console.log(key);
        }
        for (let key of formData.values()) {
            console.log(key);
        }

        fetch("/wincyj", {
            method: "POST",
            headers: {
                "X-zacznij_od" : tabelka.rows.length
            },
            body: new FormData(form1)
        })
            .then(response => response.json())
            .then(data => {
                console.log(data.more_rows);
                tabelka.innerHTML += data.more_rows;
            })
            .catch(error => {
                errorDiv.innerText = "An error occurred. Please try again later.";
            })
    });
    function delay(time) {
        return new Promise(resolve => setTimeout(resolve, time));
    }
    window.onscroll = async function(ev) {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
            form1.dispatchEvent(new Event("submit"));
            await delay(1000);
        }
    };

    const addRowForm = document.getElementById("addRow");
    const addInfoForm = document.getElementById("addInfo");
    const kategoriaSelect = document.getElementById("kategoria");
    const lokalizacjaSelect = document.getElementById("lokalizacja");
    const wlascicielSelect = document.getElementById("wlasciciel");
    const uzytkownikSelect = document.getElementById("uzytkownik");
    const statusSelect = document.getElementById("status");
    const stanSelect = document.getElementById("stan");
    const stanPrimary = document.getElementById("stan_primary");

    function clearOptions(ob) {
        for(let i = 1; i < ob.children.length; i++){
            ob.children.item(1).remove();
        }
    }

    addRowForm.addEventListener("submit", (e) => {
        e.preventDefault();
        fetch('/baza/dodaj', {
            method: "POST"
        })
            .then(response => response.json())
            .then(data => {
                clearOptions(kategoriaSelect);
                clearOptions(lokalizacjaSelect);
                clearOptions(wlascicielSelect);
                clearOptions(uzytkownikSelect);
                clearOptions(statusSelect);
                addInfoForm.style.display = "block";
                data.kategorie.forEach(element => {
                    let option = document.createElement("option");
                    option.value = element;
                    option.innerText = element;
                    kategoriaSelect.appendChild(option);
                });
                data.lokalizacje.forEach(element => {
                    let option = document.createElement("option");
                    option.value = element;
                    option.innerText = element;
                    lokalizacjaSelect.appendChild(option);
                });
                data.podmioty.forEach(element => {
                    let option = document.createElement("option");
                    option.value = element;
                    option.innerText = element;
                    wlascicielSelect.appendChild(option);
                    let option2 = document.createElement("option");
                    option2.value = element;
                    option2.innerText = element;
                    uzytkownikSelect.appendChild(option2);
                });
                data.statusy.forEach(element => {
                    let option = document.createElement("option");
                    option.value = element;
                    option.innerText = element;
                    statusSelect.appendChild(option);
                });
            })
    })
    kategoriaSelect.addEventListener("change", (e) => {
        e.preventDefault();
        let kat = (kategoriaSelect.selectedOptions[0].index);
        fetch('/baza/stany', {
            method: "POST",
            headers: {
                "X-kategoria" : kat,
            },
            body: new FormData(addRowForm)
        })
            .then(response => response.json())
            .then(data => {
                stanSelect.disabled = false;
                stanPrimary.innerText = "===";
                clearOptions(stanSelect);
                data.stany.forEach(element => {
                    let option = document.createElement("option");
                    option.value = element;
                    option.innerText = element;
                    stanSelect.appendChild(option);
                });
            });
    })
</script>
</body>
</html>